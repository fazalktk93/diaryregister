{% extends "base.html" %}
{% block title %}Reports{% endblock %}

{% block content %}
<div class="page-header mb-4">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h1 class="mb-1"><i class="bi bi-bar-chart"></i> Reports</h1>
      <p class="text-light mb-0 opacity-75">View and export comprehensive diary data</p>
    </div>
    <button class="btn btn-light" type="button" id="btnPdfLocal" aria-label="Generate PDF report">
      <i class="bi bi-file-earmark-pdf"></i> Download PDF
    </button>
  </div>
</div>

<div class="card mb-4">
  <div class="card-body">
    <form method="get" novalidate>
      <fieldset>
        <legend class="form-label fw-bold mb-3"><i class="bi bi-funnel"></i> Filter & Export</legend>
        <div class="row g-3 align-items-end">
          <div class="col-sm-3">
            <label for="id_year" class="form-label">Year</label>
            <input id="id_year" class="form-control" name="year" value="{{ filters.year }}" placeholder="e.g. 2026" inputmode="numeric" aria-label="Filter by year">
          </div>
          <div class="col-sm-auto d-flex gap-2">
            <button type="submit" class="btn btn-primary" aria-label="Apply filters">
              <i class="bi bi-search"></i> Apply
            </button>
            <a href="{% url 'reports_table' %}" class="btn btn-outline-secondary" aria-label="Reset filters">
              <i class="bi bi-arrow-clockwise"></i> Reset
            </a>
          </div>
          <div class="col text-muted small">
            <i class="bi bi-info-circle"></i> Table includes 50 rows per page with filters and full movement history
          </div>
        </div>
      </fieldset>
    </form>
  </div>
</div>

<div class="card">
  <div class="table-responsive">
    <table class="table table-hover mb-0 align-middle" role="grid" aria-label="Diary reports table">
      <thead>
        <tr role="row">
          <th scope="col"><i class="bi bi-calendar"></i> Diary No</th>
          <th scope="col">Date</th>
          <th scope="col">Rcvd No</th>
          <th scope="col">Rcvd From</th>
          <th scope="col">Type</th>
          <th scope="col" class="text-center">Folders</th>
          <th scope="col">Subject</th>
          <th scope="col">Status</th>
          <th scope="col">Movement</th>
          <th scope="col">Current</th>
        </tr>
        <tr role="row" class="table-light">
          <th scope="col">
            <input class="form-control form-control-sm" name="diary_no" value="{{ filters.diary_no }}" placeholder="2026-12" aria-label="Filter by diary number">
          </th>
          <th scope="col"></th>
          <th scope="col">
            <input class="form-control form-control-sm" name="received_diary_no" value="{{ filters.received_diary_no }}" placeholder="No" aria-label="Filter by received number">
          </th>
          <th scope="col">
            <input class="form-control form-control-sm" name="received_from" value="{{ filters.received_from }}" placeholder="Office" aria-label="Filter by received from">
          </th>
          <th scope="col">
            <input class="form-control form-control-sm" name="file_letter" value="{{ filters.file_letter }}" placeholder="File" aria-label="Filter by type">
          </th>
          <th scope="col">
            <input class="form-control form-control-sm" name="no_of_folders" value="{{ filters.no_of_folders }}" placeholder="0" aria-label="Filter by folders">
          </th>
          <th scope="col">
            <input class="form-control form-control-sm" name="subject" value="{{ filters.subject }}" placeholder="Subject" aria-label="Filter by subject">
          </th>
          <th scope="col">
            <select class="form-select form-select-sm" name="status" aria-label="Filter by status">
              <option value="">All</option>
              {% for v,l in status_choices %}
                <option value="{{ v }}" {% if filters.status == v %}selected{% endif %}>{{ l }}</option>
              {% endfor %}
            </select>
          </th>
          <th scope="col"></th>
          <th scope="col">
            <input class="form-control form-control-sm" name="marked_to" value="{{ filters.marked_to }}" placeholder="Current" aria-label="Filter by marked to">
          </th>
        </tr>
      </thead>

      <tbody>
        {% for d in page_obj.object_list %}
          <tr role="row">
            <td>
              <a href="{% url 'diary_detail' d.id %}" class="fw-bold text-decoration-none">{{ d.diary_no_short }}</a>
            </td>
            <td>
              <small class="text-muted">{{ d.diary_date|date:"M d, Y" }}</small>
            </td>
            <td>{{ d.received_diary_no|default:"—" }}</td>
            <td><small>{{ d.received_from|default:"—" }}</small></td>
            <td>
              {% if d.file_letter %}
                <span class="badge {% if d.file_letter == 'File' %}bg-primary{% else %}bg-info{% endif %}">{{ d.file_letter }}</span>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td class="text-center">
              {% if d.file_letter == "File" %}
                <span class="badge bg-success">{{ d.no_of_folders }}</span>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td class="text-truncate" style="max-width: 200px;" title="{{ d.subject|default:'' }}">
              <small>{{ d.subject|default:"—" }}</small>
            </td>
            <td>
              {% if d.status == "Pending" %}
                <span class="badge bg-warning text-dark"><i class="bi bi-hourglass-split"></i> {{ d.status }}</span>
              {% elif d.status == "Completed" %}
                <span class="badge bg-success"><i class="bi bi-check-circle"></i> {{ d.status }}</span>
              {% else %}
                <span class="badge bg-secondary">{{ d.status }}</span>
              {% endif %}
            </td>
            <td>
              <small class="text-muted d-block text-truncate" style="max-width: 180px;" title="{{ d.movement_history_plain }}">
                {{ d.movement_history_plain|truncatewords:5 }}
              </small>
            </td>
            <td><small>{{ d.marked_to|default:"—" }}</small></td>
          </tr>
        {% empty %}
          <tr role="row">
            <td colspan="10" class="text-center py-5">
              <i class="bi bi-inbox" style="font-size: 2.5rem; color: #ccc;"></i>
              <p class="text-muted mt-2">No records found. Try adjusting your filters.</p>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if page_obj.paginator.num_pages > 1 %}
    <div class="card-footer d-flex justify-content-between align-items-center">
      <div class="text-muted small">
        <strong>{{ page_obj.paginator.count }}</strong> total records — Page <strong>{{ page_obj.number }}</strong> of <strong>{{ page_obj.paginator.num_pages }}</strong>
      </div>
      <nav aria-label="Pagination navigation">
        <ul class="pagination mb-0 gap-1">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <button class="page-link" name="page" value="{{ page_obj.previous_page_number }}" aria-label="Previous page">
                <i class="bi bi-chevron-left"></i>
              </button>
            </li>
          {% endif %}
          {% if page_obj.has_next %}
            <li class="page-item">
              <button class="page-link" name="page" value="{{ page_obj.next_page_number }}" aria-label="Next page">
                <i class="bi bi-chevron-right"></i>
              </button>
            </li>
          {% endif %}
        </ul>
      </nav>
    </div>
  {% endif %}
</div>

<script>
  (function () {
    const btn = document.getElementById("btnPdfLocal");
    if (!btn) return;

    btn.addEventListener("click", function () {
      const year = prompt("Enter year for PDF (e.g. 2026):", "{{ filters.year|default:'' }}");
      if (!year) return;
      const y = year.trim();
      if (!/^\d{4}$/.test(y)) {
        alert("Please enter a valid 4-digit year (e.g. 2026).");
        return;
      }
      const url = "{% url 'reports_pdf' 2000 %}".replace("2000", y);
      window.open(url, "_blank", "noopener,noreferrer");
    });
  })();
</script>
{% endblock %}
