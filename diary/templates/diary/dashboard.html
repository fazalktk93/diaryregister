{% extends "base.html" %}
{% block title %}Dashboard - Diary Register{% endblock %}

{% block content %}
<style>
  .dashboard-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; }
  .stat-card { transition: transform 0.2s, box-shadow 0.2s; border: none; }
  .stat-card:hover { transform: translateY(-4px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
  .month-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; }
  .month-card .count { font-size: 2rem; font-weight: 700; }
  .month-card .month-name { font-size: 0.9rem; opacity: 0.9; }
  .year-card { background: white; border: 2px solid #667eea; cursor: pointer; transition: all 0.2s; }
  .year-card:hover { background: #667eea; color: white; }
  .year-card.active { background: #667eea; color: white; }
  .badge-count { font-size: 1.2rem; padding: 0.5rem 0.75rem; }
</style>

<div class="dashboard-header p-5 mb-4">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h1 class="mb-2">üìä Dashboard</h1>
      <p class="mb-0 opacity-75">Welcome back! Here's your diary summary.</p>
    </div>
    <div class="btn-group" role="group" aria-label="Main navigation">
      <a class="btn btn-light" href="{% url 'diary_list' %}" aria-label="Go to Diary list"><i class="bi bi-list-ul"></i> Diary</a>
      <a class="btn btn-light" href="{% url 'reports_table' %}" aria-label="Go to Reports"><i class="bi bi-bar-chart"></i> Reports</a>
      <a class="btn btn-light" href="{% url 'directory' %}" aria-label="Go to Office Directory"><i class="bi bi-building"></i> Directory</a>
      <button class="btn btn-warning fw-bold" data-bs-toggle="modal" data-bs-target="#newDiaryModal" aria-label="Create a new diary"><i class="bi bi-plus-lg"></i> New Diary</button>
    </div>
  </div>
</div>

<div class="container-fluid">
  <div class="row g-4">
    <!-- Years Panel -->
    <div class="col-lg-3">
      <div class="card h-100" style="border-radius: 12px; overflow: hidden;">
        <div class="card-header bg-dark text-white d-flex align-items-center gap-2">
          <span style="font-size: 1.5rem;">üìÖ</span>
          <h5 class="mb-0">Years</h5>
        </div>
        <div class="list-group list-group-flush" style="max-height: 500px; overflow-y: auto;">
          {% for y in years %}
            <a href="{% url 'diary_year_report' y.year %}" class="year-card list-group-item list-group-item-action d-flex justify-content-between align-items-center p-3 {% if y.year == year %}active{% endif %}" role="button" aria-label="View year {{ y.year }} with {{ y.count }} diaries">
              <div class="fw-600">{{ y.year }}</div>
              <span class="badge bg-secondary badge-count">{{ y.count }}</span>
            </a>
          {% empty %}
            <div class="list-group-item text-muted text-center py-4">
              <p class="mb-0">No diary records yet</p>
              <small>Start by creating a new diary</small>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Months Panel -->
    <div class="col-lg-9">
      <div class="card h-100" style="border-radius: 12px; overflow: hidden;">
        <div class="card-header bg-dark text-white d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center gap-2">
            <span style="font-size: 1.5rem;">üìà</span>
            <h5 class="mb-0">Monthly Breakdown ‚Äî {{ year }}</h5>
          </div>
          <div class="small text-light">
            Total: <span class="fw-bold" id="total-count">0</span>
          </div>
        </div>
        <div class="card-body">
          <div class="row g-3" id="months-grid">
            {% for m in months %}
              <div class="col-md-4 col-lg-3">
                <div class="month-card p-4 text-center" style="border-radius: 10px; cursor: pointer;" data-year="{{ year }}" data-month="{{ m.month }}" onclick="filterByMonth('{{ m.month }}');" role="button" tabindex="0" aria-label="{{ m.name }} - {{ m.count }} diaries">
                  <div class="month-name fw-500">{{ m.name }}</div>
                  <div class="count mt-2">{{ m.count }}</div>
                  <small class="d-block mt-2 opacity-75">Click to filter</small>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Stats -->
  <div class="row g-4 mt-1">
    <div class="col-md-6">
      <div class="stat-card card" style="border-radius: 12px;">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-muted mb-1">Total Diaries</h6>
              <h3 class="mb-0">
                <span id="total-diaries">0</span>
              </h3>
            </div>
            <span style="font-size: 3rem; opacity: 0.1;">üìÑ</span>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="stat-card card" style="border-radius: 12px;">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-muted mb-1">Year Selected</h6>
              <h3 class="mb-0">{{ year }}</h3>
              <small class="text-muted">Click a year on the left to switch</small>
            </div>
            <span style="font-size: 3rem; opacity: 0.1;">üóìÔ∏è</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

<!-- ========== New Diary Modal ========== -->
<div class="modal fade" id="newDiaryModal" tabindex="-1" aria-labelledby="newDiaryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content" style="border-radius: 12px;">
      <form method="post" novalidate>
        {% csrf_token %}
        <div class="modal-header bg-dark text-white" style="border-radius: 12px 12px 0 0;">
          <h5 class="modal-title" id="newDiaryModalLabel"><i class="bi bi-plus-circle"></i> Create New Diary</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          {% if create_form %}
            <div class="row g-3">
              <div class="col-md-4">
                <label for="{{ create_form.diary_date.id_for_label }}" class="form-label">{{ create_form.diary_date.label }}</label>
                {% now "Y-m-d" as today %}
                <input type="date" class="form-control" value="{{ today }}" disabled>
                <input type="hidden" name="diary_date" value="{{ today }}">
                {% if create_form.diary_date.errors %}
                  <div class="text-danger small">{{ create_form.diary_date.errors|striptags }}</div>
                {% endif %}
              </div>

              <div class="col-md-4">
                <label for="{{ create_form.received_diary_no.id_for_label }}" class="form-label">{{ create_form.received_diary_no.label }}</label>
                {{ create_form.received_diary_no }}
                {% if create_form.received_diary_no.errors %}
                  <div class="text-danger small">{{ create_form.received_diary_no.errors|striptags }}</div>
                {% endif %}
              </div>

              <div class="col-md-4">
                <label for="{{ create_form.received_from.id_for_label }}" class="form-label">{{ create_form.received_from.label }}</label>
                {{ create_form.received_from }}
                {% if create_form.received_from.errors %}
                  <div class="text-danger small">{{ create_form.received_from.errors|striptags }}</div>
                {% endif %}
              </div>

              <div class="col-md-4">
                <label for="{{ create_form.marked_to.id_for_label }}" class="form-label">{{ create_form.marked_to.label }}</label>
                {{ create_form.marked_to }}
                {% if create_form.marked_to.errors %}
                  <div class="text-danger small">{{ create_form.marked_to.errors|striptags }}</div>
                {% endif %}
              </div>

              <div class="col-md-4">
                <label for="{{ create_form.file_letter.id_for_label }}" class="form-label">{{ create_form.file_letter.label }}</label>
                {{ create_form.file_letter }}
                {% if create_form.file_letter.errors %}
                  <div class="text-danger small">{{ create_form.file_letter.errors|striptags }}</div>
                {% endif %}
              </div>

              <div class="col-md-4">
                <label for="{{ create_form.no_of_folders.id_for_label }}" class="form-label">{{ create_form.no_of_folders.label }}</label>
                {{ create_form.no_of_folders }}
                {% if create_form.no_of_folders.errors %}
                  <div class="text-danger small">{{ create_form.no_of_folders.errors|striptags }}</div>
                {% endif %}
              </div>

              <div class="col-md-12">
                <label for="{{ create_form.subject.id_for_label }}" class="form-label">{{ create_form.subject.label }}</label>
                {{ create_form.subject }}
                {% if create_form.subject.errors %}
                  <div class="text-danger small">{{ create_form.subject.errors|striptags }}</div>
                {% endif %}
              </div>

              <div class="col-md-12">
                <label for="{{ create_form.remarks.id_for_label }}" class="form-label">{{ create_form.remarks.label }}</label>
                {{ create_form.remarks }}
                {% if create_form.remarks.errors %}
                  <div class="text-danger small">{{ create_form.remarks.errors|striptags }}</div>
                {% endif %}
              </div>
            </div>

            {% if create_form.non_field_errors %}
              <div class="alert alert-danger mt-3 mb-0">{{ create_form.non_field_errors }}</div>
            {% endif %}
          {% else %}
            <div class="alert alert-info mb-0">Create form not provided.</div>
          {% endif %}
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary fw-bold">Create Diary</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Enable "No. of folders" only when File is selected
  document.addEventListener("DOMContentLoaded", function () {
    const kind = document.getElementById("id_file_letter");
    const folders = document.getElementById("id_no_of_folders");

    function syncFoldersState() {
      if (!kind || !folders) return;
      const isFile = (kind.value || "").toLowerCase() === "file";
      folders.disabled = !isFile;

      const wrap = folders.closest(".col-md-4") || folders.closest(".mb-3");
      if (wrap) wrap.classList.toggle("opacity-50", !isFile);

      if (!isFile) folders.value = 0;
    }

    if (kind && folders) {
      kind.addEventListener("change", syncFoldersState);
      syncFoldersState();
    }

    // If form has errors, reopen modal automatically
    const formErrors = document.querySelectorAll(".text-danger");
    if (formErrors.length > 0) {
      const el = document.getElementById("newDiaryModal");
      if (el) new bootstrap.Modal(el).show();
    }
  });

  // Filter diaries by month when clicking month card
  function filterByMonth(month) {
    const year = "{{ year }}";
    window.location.href = `{% url 'diary_list' %}?year=${year}&page=1`;
  }

  // Calculate and display total
  document.addEventListener("DOMContentLoaded", function () {
    const counts = Array.from(document.querySelectorAll(".month-card .count"))
      .map(el => parseInt(el.textContent) || 0)
      .reduce((a, b) => a + b, 0);
    const totalEl = document.getElementById("total-diaries");
    if (totalEl) totalEl.textContent = counts;
  });
</script>
