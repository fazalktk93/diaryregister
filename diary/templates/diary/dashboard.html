{% extends "base.html" %}
{% block title %}Dashboard - Diary{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h3 class="mb-0">Dashboard</h3>
    <div class="text-muted">Summary for {{ year }}</div>
  </div>
  <div class="btn-group">
    <a class="btn btn-outline-secondary" href="{% url 'diary_list' %}">Diary</a>
    <a class="btn btn-outline-secondary" href="{% url 'reports_table' %}">Reports</a>
    <a class="btn btn-outline-secondary" href="{% url 'directory' %}">Directory</a>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newDiaryModal">+ New Diary</button>
  </div>
</div>
<div class="row g-3">
  <div class="col-md-3">
    <div class="card mb-3">
      <div class="card-header">Years</div>
      <div class="list-group list-group-flush">
        {% for y in years %}
          <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" href="{% url 'diary_year_report' y.year %}">
            <div>Year {{ y.year }}</div>
            <span class="badge bg-secondary rounded-pill">{{ y.count }}</span>
          </a>
        {% empty %}
          <div class="list-group-item text-muted">No data</div>
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="col-md-9">
    <div class="card mb-3">
      <div class="card-header">Months â€” {{ year }}</div>
      <div class="card-body">
        <div class="row g-3">
          {% for m in months %}
            <div class="col-md-3">
              <div class="card">
                <div class="card-body d-flex justify-content-between align-items-center">
                  <div>
                    <div class="text-muted">{{ m.name }}</div>
                    <h5 class="mb-0">{{ m.count }}</h5>
                  </div>
                  <div>
                    <a class="btn btn-outline-primary btn-sm" href="{% url 'diary_list' %}?year={{ year }}&page=1">Open</a>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

<!-- ========== New Diary Modal ========== -->
<div class="modal fade" id="newDiaryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <!-- POST to same dashboard view so errors can reopen modal -->
      <form method="post" novalidate>
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Create New Diary</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          {% if create_form %}

            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">{{ create_form.diary_date.label }}</label>
                {{ create_form.diary_date }}
                {% if create_form.diary_date.errors %}
                  <div class="text-danger small">{{ create_form.diary_date.errors|striptags }}</div>
                {% endif %}
              </div>

              <div class="col-md-4">
                <label class="form-label">{{ create_form.received_diary_no.label }}</label>
                {{ create_form.received_diary_no }}
                {% if create_form.received_diary_no.errors %}
                  <div class="text-danger small">{{ create_form.received_diary_no.errors|striptags }}</div>
                {% endif %}
              </div>

              <div class="col-md-4">
                <label class="form-label">{{ create_form.received_from.label }}</label>
                {{ create_form.received_from }}
                {% if create_form.received_from.errors %}
                  <div class="text-danger small">{{ create_form.received_from.errors|striptags }}</div>
                {% endif %}
              </div>
      {% if can_view_sensitive %}
      <div class="col-md-4">
      <label class="form-label">{{ create_form.marked_to.label }}</label>
      {{ create_form.marked_to }}
      {% if create_form.marked_to.errors %}
        <div class="text-danger small">{{ create_form.marked_to.errors|striptags }}</div>
      {% endif %}
      </div>
      {% endif %}

              <div class="col-md-4">
                <label class="form-label">{{ create_form.file_letter.label }}</label>
                {{ create_form.file_letter }}
                {% if create_form.file_letter.errors %}
                  <div class="text-danger small">{{ create_form.file_letter.errors|striptags }}</div>
                {% endif %}
              </div>

              <div class="col-md-4">
                <label class="form-label">{{ create_form.no_of_folders.label }}</label>
                {{ create_form.no_of_folders }}
                {% if create_form.no_of_folders.errors %}
                  <div class="text-danger small">{{ create_form.no_of_folders.errors|striptags }}</div>
                {% endif %}
              </div>

              <div class="col-md-12">
                <label class="form-label">{{ create_form.subject.label }}</label>
                {{ create_form.subject }}
                {% if create_form.subject.errors %}
                  <div class="text-danger small">{{ create_form.subject.errors|striptags }}</div>
                {% endif %}
              </div>

              <div class="col-md-12">
                <label class="form-label">{{ create_form.remarks.label }}</label>
                {{ create_form.remarks }}
                {% if create_form.remarks.errors %}
                  <div class="text-danger small">{{ create_form.remarks.errors|striptags }}</div>
                {% endif %}
              </div>
            </div>

            {% if create_form.non_field_errors %}
              <div class="alert alert-danger mt-3 mb-0">{{ create_form.non_field_errors }}</div>
            {% endif %}

          {% else %}
            <div class="alert alert-info mb-0">
              Create form not provided.
            </div>
          {% endif %}
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary">Create</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Enable "No. of folders" only when File is selected
  document.addEventListener("DOMContentLoaded", function () {
    const kind = document.getElementById("id_file_letter");
    const folders = document.getElementById("id_no_of_folders");

    function syncFoldersState() {
      if (!kind || !folders) return;
      const isFile = (kind.value || "").toLowerCase() === "file";
      folders.disabled = !isFile;

      const wrap = folders.closest(".col-md-4") || folders.closest(".mb-3");
      if (wrap) wrap.classList.toggle("opacity-50", !isFile);

      if (!isFile) folders.value = 0;
    }

    if (kind && folders) {
      kind.addEventListener("change", syncFoldersState);
      syncFoldersState();
    }

    // If server returned errors, reopen modal automatically
    {% if create_form and create_form.errors %}
      const el = document.getElementById("newDiaryModal");
      if (el) new bootstrap.Modal(el).show();
    {% endif %}
  });
</script>
